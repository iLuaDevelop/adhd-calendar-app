name: Auto-Update Changelog

on:
  push:
    branches:
      - main
      - master
  # Test webhook

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Parse Commit and Post to Firebase
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
        run: |
          # Get the latest commit message and author
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          
          # Parse title and description from commit message
          # New format: "Title | Description"
          # Example: "Fixed commit parsing | Now extracts title and description correctly"
          # Emoji will be assigned randomly by the app
          
          TITLE=""
          DESC=""
          
          # Get the full message after first space (remove commit type if present)
          MSG="$COMMIT_MSG"
          
          # Check if pipe exists and split
          if [[ "$MSG" == *"|"* ]]; then
            # Split on pipe using parameter expansion
            TITLE="${MSG%%|*}"
            DESC="${MSG#*|}"
            # Trim whitespace
            TITLE=$(echo "$TITLE" | xargs)
            DESC=$(echo "$DESC" | xargs)
          else
            TITLE="$MSG"
            DESC=""
          fi
          
          # Skip if empty
          if [ -z "$TITLE" ]; then
            echo "Skipping: No title found"
            exit 0
          fi
          if [ -z "$EMOJI" ] || [ -z "$TITLE" ]; then
            EMOJI="üìù"
            TITLE=$(echo "$COMMIT_MSG" | head -1)
            DESC=$(echo "$COMMIT_MSG" | tail -n +2 | head -1)
          fi
          
          # Skip if commit message starts with "chore:" or "docs:"
          if [[ $TITLE == chore* ]] || [[ $TITLE == docs* ]]; then
            echo "Skipping chore/docs commit"
            exit 0
          fi
          
          # Install firebase-admin locally in temp directory
          mkdir -p /tmp/firebase-app
          cd /tmp/firebase-app
          npm init -y > /dev/null 2>&1
          npm install firebase-admin > /dev/null 2>&1
          
          # Create Node script to add update
          cat > add-update.js << 'EOF'
          const admin = require('firebase-admin');
          const serviceAccount = {
            type: 'service_account',
            project_id: process.env.FIREBASE_PROJECT_ID,
            private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
            client_email: process.env.FIREBASE_CLIENT_EMAIL
          };
          
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount)
          });
          
          const db = admin.firestore();
          const title = process.argv[2];
          const desc = process.argv[3];
          const hash = process.argv[4];
          
          // Random emojis for commits
          const emojis = ['üîß', '‚ú®', 'üéØ', 'üöÄ', 'üêõ', 'üìù', '‚ö°', 'üé®', 'üí°', 'üî®'];
          const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
          
          db.collection('updates').add({
            icon: randomEmoji,
            title: title,
            desc: desc,
            active: true,
            type: 'commit',
            timestamp: admin.firestore.FieldValue.serverTimestamp(),
            commitHash: hash
          }).then(() => {
            console.log('‚úÖ Update added to Firebase!');
            process.exit(0);
          }).catch(err => {
            console.error('‚ùå Error:', err.message);
            process.exit(1);
          });
          EOF
          
          # Add update to Firebase
          node add-update.js "$TITLE" "$DESC" "$COMMIT_HASH"

name: Auto-Update Changelog

on:
  push:
    branches:
      - main
      - master

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Parse Commit and Post to Firebase
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
        run: |
          # Get the latest commit message and author
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          
          # Parse emoji and title from commit message
          # Format: "emoji label: title - description"
          # Example: "‚ú® feat: Pet display improvements - Added level badges to compact views"
          
          # Extract emoji (first word)
          EMOJI=$(echo "$COMMIT_MSG" | awk '{print $1}')
          
          # Remove emoji and label (everything up to and including the colon and space)
          # Then split on dash to get title and description
          TEMP=$(echo "$COMMIT_MSG" | sed 's/^[^ ]* [^:]*:[[:space:]]*//')
          
          # Extract title (everything before the dash)
          TITLE=$(echo "$TEMP" | sed 's/[[:space:]]*-[[:space:]]*/\n/g' | head -1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Extract description (everything after the dash)
          DESC=$(echo "$TEMP" | sed 's/^[^-]*-[[:space:]]*//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Fallback if something went wrong
          if [ -z "$EMOJI" ] || [ -z "$TITLE" ]; then
            EMOJI="üìù"
            TITLE=$(echo "$COMMIT_MSG" | head -1)
            DESC=$(echo "$COMMIT_MSG" | tail -n +2 | head -1)
          fi
          
          # Skip if commit message starts with "chore:" or "docs:"
          if [[ $TITLE == chore* ]] || [[ $TITLE == docs* ]]; then
            echo "Skipping chore/docs commit"
            exit 0
          fi
          
          # Install firebase-admin locally in temp directory
          mkdir -p /tmp/firebase-app
          cd /tmp/firebase-app
          npm init -y > /dev/null 2>&1
          npm install firebase-admin > /dev/null 2>&1
          
          # Create Node script to add update
          cat > add-update.js << 'EOF'
          const admin = require('firebase-admin');
          const serviceAccount = {
            type: 'service_account',
            project_id: process.env.FIREBASE_PROJECT_ID,
            private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
            client_email: process.env.FIREBASE_CLIENT_EMAIL
          };
          
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount)
          });
          
          const db = admin.firestore();
          const emoji = process.argv[2];
          const title = process.argv[3];
          const desc = process.argv[4];
          const hash = process.argv[5];
          
          db.collection('updates').add({
            icon: emoji,
            title: title,
            desc: desc,
            active: true,
            type: 'commit',
            timestamp: admin.firestore.FieldValue.serverTimestamp(),
            commitHash: hash
          }).then(() => {
            console.log('‚úÖ Update added to Firebase!');
            process.exit(0);
          }).catch(err => {
            console.error('‚ùå Error:', err.message);
            process.exit(1);
          });
          EOF
          
          # Add update to Firebase
          node add-update.js "$EMOJI" "$TITLE" "$DESC" "$COMMIT_HASH"
